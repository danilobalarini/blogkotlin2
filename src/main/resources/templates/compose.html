<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
	  xmlns:spring="http://www.springframework.org/tags" 
	  xmlns:form="http://www.springframework.org/tags/form">

<head>
	<title>Admin</title>
	<!--/*/ <th:block th:include="fragments/general.html :: headerfiles_level_1"> </th:block> /*/-->
	<link th:href="@{../webjars/bootstrap/3.4.1/css/bootstrap.css}" rel="stylesheet">
	<script th:src="@{../webjars/bootstrap/3.4.1/js/bootstrap.min.js}"></script>

	<!-- add summernote -->
	<link href="https://cdn.jsdelivr.net/npm/summernote@0.8.12/dist/summernote.min.css" rel="stylesheet">
	<script src="https://cdn.jsdelivr.net/npm/summernote@0.8.12/dist/summernote.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/summernote@0.8.12/dist/lang/summernote-pt-BR.min.js"></script>
	<script type="text/javascript" th:src="@{../javascript/summernote-ext-highlight.js}"></script>

	<link rel="stylesheet" type="text/css" media="all" th:href="@{../webjars/font-awesome/5.13.0/css/fontawesome.min.css}" />

	<!-- multiple select -->
	<link  th:href="@{../css/multi-select.css}" rel="stylesheet">
	<script th:src="@{../javascript/jquery.multi-select.js}" type="text/javascript"></script>

	<link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">

	<style>
		#left {
			width: 50%;
			display: inline-block;
		}
		#right {
			width: 50%;
			display: inline-block;
		}
	</style>
	</head>

<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<body>

	<div th:replace="fragments/general.html :: header"></div>
	
	<div class="content-wrapper">
		<div class="w-container">
			<div class="w-row" style="border: 1px dotted black; padding: 2px;">
				
				<div class="w-col" style="border: 1px dotted red;">
					<div id="left" style="border: 1px dotted green;">
						<form method="POST" enctype="multipart/form-data" id="fileUploadForm">
							<input type="hidden" id="id" name="id" th:value="${post.id}">
							<div class="w-col" style="border: 1px solid #000000;">
								<div id="preview-cover-image"
									class="blog-composer-coverimage w-inline-block"
									th:style="'background-image: url('+ ${post.coverImage} +');'">
								</div>
							</div>
							<input type="file" name="coverImage" id="coverImage" /> <br/>
							&nbsp;&nbsp;&nbsp;<a class="button" id="btnCoverImage">Upload Imagem de Capa</a>
						</form>
					</div>

					<div id="right" style="border: 1px dotted violet; position: absolute;">
						<a class="navigation-link w-nav-link" th:href="@{/admin/tags}">Gerenciar Tags</a>
						<select multiple="multiple" id="tagsSelect" name="tagSelect">
							<option th:each="tag: ${alltags}" 
									th:value="${tag.id}" 
									th:text="${tag.name}">
							</option>
						</select>
						<br/>
						<a class="button" id="btnSaveTags">Salvar Tags</a>
					</div>

				</div>

				<div class="w-col" style="border: 1px dotted blue; width: 100%;">
					<input type="hidden" id="postid" name="hidpost" th:field="${post.id}">
					<input type="hidden" id="hidtags" name="hidtags" th:value="${idtags}">
					<br/>
					<input type="text" id="posttitle" name="txtTitle" th:field="${post.title}" size="60">
					<br/><br/>
					<div id="summernote" name="article"></div>

					<p>É rascunho?&nbsp;&nbsp;<input type="checkbox" id="postdraft" name="postdraft" th:field="${post.draft}"></p>

					<p>
						<input type="button" value="Save" id="executeForm" name="btnAction" onclick="updater();">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
						<input type="button" value="Return" id="btnReturn" name="btnReturn" onclick="goback();">
					</p>

					<!-- div th:replace="fragments/general.html :: mobile-sidebar_level_1"></div -->

					<span id="spanPost" th:utext="${post.text}"></span>

				</div>
			</div>

		</div>
	</div>

	<div th:replace="fragments/general.html :: footerfiles"></div>

	<script th:inline="javascript">

		$(document).ready(function() {

			$('#tagsSelect').multiSelect();
			console.log("tags: " + $('#hidtags').val())
			var tags = $('#hidtags').val().split(',');
			for(var x=0;x<tags.length;x++) {
				$('#tagsSelect').multiSelect('select', tags[x]);
			}

			var autosave_timer = null

			$('#summernote').summernote({
				fontNames: ['Arial', 'Arial Black', 'Comic Sans MS', 'Courier New', 'Helvetica', 'Impact', 'Tahoma', 'Times New Roman', 'Verdana', 'Roboto'],
  				fontNamesIgnoreCheck: ['Roboto'],
				prettifyHtml: false,
				toolbar:[
					['style', ['style']],
					['font', ['bold', 'underline', 'clear']],
					['fontname', ['fontname']],
					['color', ['color']],
					['para', ['ul', 'ol', 'paragraph']],
//					['table', ['table']],
					['insert', ['link', 'picture', 'video']],
        			// Add highlight plugin
					['highlight', ['highlight']],
					['view', ['fullscreen', 'codeview', 'help']],
    			],
				callbacks: {
					onInit: function() {
						var ptext = $('#spanPost').html();
						$('#summernote').summernote('code', ptext);
						$('#spanPost').remove();
					},
					onChange: function(e) {
						clearTimeout(autosave_timer);
						autosave_timer = setTimeout(function() {
							console.log("saving information");
							updater();
						}, 15000);
					},
					onImageUpload: function(files) {
						console.log("nº arquivos: " + files.length)
						var file = files[0];
						console.log("filename: " + file.name)
            			sendFile(files[0]);
        			},
					onMediaDelete : function(target) {
                		console.log(target[0].src);
                		//deleteFile(target[0].src);
            		}
				}
			});

            $('.preview-btn').click(function () {
                $('#preview-box').html($('.summernote').summernote('code'));
                prettyPrint();
            });

			$("#btnCoverImage").click(function() {
				var form = $('#fileUploadForm')[0];
				var formData = new FormData(form);

				$.ajax({
					url: "/postImage/updateCoverImage",
					type: "POST",
					enctype: 'multipart/form-data',
					data: formData,
					contentType: false,
					processData: false,
					cache: false,
					success: function (data) {
						$("#preview-cover-image").css('background-image', 'url(' + data + ')');
                    },
                    error : function(jqXHR, textStatus, errorThrown) {
						console.log("erro na atualização da imagem de capa");
                     	console.log("jqXHR: " + jqXHR.status);
                     	console.log("textStatus: " + textStatus);
                     	console.log("errorThrown: " + errorThrown);
                    }
				});
			});

			$("#btnSaveTags").click(function() {
				console.log("valores selecionados: " + $("#tagsSelect").val())
				console.log("post: "+ $('#postid').val());
				
				var idsInCsv = '' + $("#tagsSelect").val();
				var ids = getFromCSV(idsInCsv);

				var listTags = [];
				for(var x=0;x<ids.length;x++) {
					var tag = {
						id:ids[x]
					}
					listTags.push(tag);
				}

				console.log("listTags.length: " +  listTags.length)

				var obj = {
						id:parseInt($('#postid').val()),
						tags:listTags
				}

				console.log("obj: " + JSON.stringify(obj));
				
				$.ajax({
					url: "/post/updatetags",
					type: "POST",
					data: JSON.stringify(obj),
					contentType: "application/json; charset=utf-8",
					cache: false,
					processData: false,
					success: function (data) {
						console.log("resposta: " + data)
						console.log("as tags foram atualizadas com sucesso!!!");
                    },
                    error : function(jqXHR, textStatus, errorThrown) {
						console.log("erro na atualização das tags");
                     	console.log("jqXHR: " + jqXHR.status);
                     	console.log("textStatus: " + textStatus);
                     	console.log("errorThrown: " + errorThrown);
                    }
				});

			});

			function getFromCSV(data) {
				var csv = data.split(",");
				var ids = [];

				for(var x=0;x<csv.length;x++) {
					ids.push(parseInt(csv[x]));
				}
				return ids;
			}

		});

		function sendFile(file) {
			console.log("started send file...");
			data = new FormData();
			data.append('id', $('#postid').val());
			data.append("image", file);

			$.ajax({
				data: data,
				type: "POST",
				url: "/postImage/save",
				cache: false,
				contentType: false,
				processData: false,
				success: function(url) {
					console.log("URL: " + url)
					$('#summernote').summernote("insertImage", url);
				},
				error : function(jqXHR, textStatus, errorThrown) {
					console.log("jqXHR: " + jqXHR.status);
					console.log("textStatus: " + textStatus);
					console.log("errorThrown: " + errorThrown);
				}
			});
		}
		
		function updater() {

			var postid = $('#postid').val();
			var posttitle = $('#posttitle').val();
			var posttext = $('#summernote').summernote('code');
			var postdraft = $('#postdraft').is(':checked');

			var post = {
				id : postid,
				title : posttitle,
				text : posttext, 
				isDraft : postdraft
			};

			// record start time
			var startTime = new Date();

			$.ajax({
				type: "POST",
				url: "/post/update",
				data: JSON.stringify(post),
				contentType: "application/json; charset=utf-8",
				dataType: "json",
				success: function (data) {
						console.log("post atualizado com sucesso!!!");
                },
                error : function(jqXHR, textStatus, errorThrown) {
					console.log("erro na atualização do composer");
					console.log("jqXHR: " + jqXHR.status);
					console.log("textStatus: " + textStatus);
					console.log("errorThrown: " + errorThrown);
				}
			});

			// later record end time
			var endTime = new Date();

			// time difference in ms
			var timeDiff = endTime - startTime;

			// strip the ms
			timeDiff /= 1000;
			console.log("timeDiff: " + timeDiff);

			// get seconds (Original had 'round' which incorrectly counts 0:28, 0:29, 1:30 ... 1:59, 1:0)
			var seconds = Math.round(timeDiff % 60);
			console.log("seconds: " + seconds);

		}

		function goback() {
			window.location.href = "/admin";
		}

	</script>

</body>

</html>